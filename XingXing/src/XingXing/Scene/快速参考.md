# Scene æ¨¡å—å¿«é€Ÿå‚è€ƒå¡

> ğŸ’¡ è¿™æ˜¯ä¸€ä¸ªé€ŸæŸ¥æ‰‹å†Œï¼Œæä¾›æœ€å¸¸ç”¨çš„ API å’Œä»£ç ç‰‡æ®µã€‚è¯¦ç»†æ–‡æ¡£è¯·å‚é˜… [Sceneæ¨¡å—è¯¦è§£.md](./Sceneæ¨¡å—è¯¦è§£.md)

## ç›®å½•

- [åœºæ™¯ç®¡ç†](#åœºæ™¯ç®¡ç†)
- [å®ä½“æ“ä½œ](#å®ä½“æ“ä½œ)
- [ç»„ä»¶æ“ä½œ](#ç»„ä»¶æ“ä½œ)
- [å¸¸ç”¨ç»„ä»¶](#å¸¸ç”¨ç»„ä»¶)
- [è„šæœ¬å¼€å‘](#è„šæœ¬å¼€å‘)
- [ç‰©ç†ç³»ç»Ÿ](#ç‰©ç†ç³»ç»Ÿ)
- [åœºæ™¯åºåˆ—åŒ–](#åœºæ™¯åºåˆ—åŒ–)

---

## åœºæ™¯ç®¡ç†

### åˆ›å»ºåœºæ™¯
```cpp
Ref<Scene> scene = CreateRef<Scene>();
```

### ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
```cpp
// å¼€å§‹è¿è¡Œ
scene->OnRuntimeStart();

// æ¸¸æˆå¾ªç¯æ›´æ–°
scene->OnUpdateRuntime(timestep);

// åœæ­¢è¿è¡Œ
scene->OnRuntimeStop();

// ç¼–è¾‘å™¨æ¨¡å¼æ›´æ–°
scene->OnUpdateEditor(timestep, editorCamera);

// è§†å£å¤§å°è°ƒæ•´
scene->OnViewportResize(width, height);
```

### æš‚åœæ§åˆ¶
```cpp
// æš‚åœ/æ¢å¤
scene->SetPaused(true);   // æš‚åœ
scene->SetPaused(false);  // æ¢å¤

// å•æ­¥æ‰§è¡Œ
scene->Step(1);  // æ‰§è¡Œ1å¸§
```

---

## å®ä½“æ“ä½œ

### åˆ›å»ºå®ä½“
```cpp
// åˆ›å»ºç©ºå®ä½“
Entity entity = scene->CreateEntity();

// åˆ›å»ºå¸¦åç§°çš„å®ä½“
Entity player = scene->CreateEntity("Player");

// ä½¿ç”¨æŒ‡å®š UUID åˆ›å»º
Entity entity = scene->CreateEntityWithUUID(uuid, "EntityName");
```

### æŸ¥æ‰¾å®ä½“
```cpp
// æŒ‰åç§°æŸ¥æ‰¾
Entity entity = scene->FindEntityByName("Player");

// æŒ‰ UUID æŸ¥æ‰¾
Entity entity = scene->GetEntityByUUID(uuid);

// è·å–ä¸»ç›¸æœº
Entity camera = scene->GetPrimaryCameraEntity();
```

### å®ä½“æ“ä½œ
```cpp
// å¤åˆ¶å®ä½“
Entity clone = scene->DuplicateEntity(original);

// é”€æ¯å®ä½“
scene->DestroyEntity(entity);

// è·å–å®ä½“ä¿¡æ¯
UUID id = entity.GetUUID();
std::string name = entity.GetName();

// æ£€æŸ¥å®ä½“æœ‰æ•ˆæ€§
if (entity) { /* å®ä½“æœ‰æ•ˆ */ }
```

### éå†å®ä½“
```cpp
// è·å–å…·æœ‰ç‰¹å®šç»„ä»¶çš„æ‰€æœ‰å®ä½“
auto view = scene->GetAllEntitiesWith<TransformComponent, SpriteRendererComponent>();
for (auto entityHandle : view)
{
    Entity entity = { entityHandle, scene.get() };
    auto& transform = entity.GetComponent<TransformComponent>();
    auto& sprite = entity.GetComponent<SpriteRendererComponent>();
    // å¤„ç†å®ä½“...
}
```

---

## ç»„ä»¶æ“ä½œ

### æ·»åŠ ç»„ä»¶
```cpp
// æ·»åŠ ç»„ä»¶ï¼ˆç»„ä»¶ä¸èƒ½é‡å¤æ·»åŠ ï¼‰
auto& sprite = entity.AddComponent<SpriteRendererComponent>();

// æ·»åŠ æˆ–æ›¿æ¢ç»„ä»¶
auto& sprite = entity.AddOrReplaceComponent<SpriteRendererComponent>();

// æ·»åŠ ç»„ä»¶å¹¶ä¼ é€’æ„é€ å‚æ•°
auto& tag = entity.AddComponent<TagComponent>("EntityName");
```

### è·å–ç»„ä»¶
```cpp
// è·å–ç»„ä»¶å¼•ç”¨ï¼ˆç»„ä»¶å¿…é¡»å­˜åœ¨ï¼‰
auto& transform = entity.GetComponent<TransformComponent>();

// ä¿®æ”¹ç»„ä»¶æ•°æ®
transform.Translation.x = 10.0f;
transform.Translation.y = 5.0f;
```

### æ£€æŸ¥ç»„ä»¶
```cpp
// æ£€æŸ¥ç»„ä»¶æ˜¯å¦å­˜åœ¨
if (entity.HasComponent<SpriteRendererComponent>())
{
    // å®ä½“æœ‰ç²¾çµæ¸²æŸ“ç»„ä»¶
}
```

### ç§»é™¤ç»„ä»¶
```cpp
// ç§»é™¤ç»„ä»¶
entity.RemoveComponent<Rigidbody2DComponent>();
```

---

## å¸¸ç”¨ç»„ä»¶

### TransformComponent (è‡ªåŠ¨æ·»åŠ )
```cpp
auto& transform = entity.GetComponent<TransformComponent>();

// ä½ç½®
transform.Translation = { 0.0f, 5.0f, 0.0f };
transform.Translation.x += 1.0f;

// æ—‹è½¬ï¼ˆæ¬§æ‹‰è§’ï¼Œå¼§åº¦ï¼‰
transform.Rotation = { 0.0f, 0.0f, glm::radians(45.0f) };

// ç¼©æ”¾
transform.Scale = { 2.0f, 2.0f, 1.0f };

// è·å–å˜æ¢çŸ©é˜µ
glm::mat4 matrix = transform.GetTransform();
```

### SpriteRendererComponent
```cpp
auto& sprite = entity.AddComponent<SpriteRendererComponent>();

// è®¾ç½®é¢œè‰²
sprite.Color = { 1.0f, 0.0f, 0.0f, 1.0f };  // çº¢è‰²

// åŠ è½½çº¹ç†
sprite.Texture = Texture2D::Create("assets/sprite.png");

// çº¹ç†å¹³é“º
sprite.TilingFactor = 2.0f;
```

### CircleRendererComponent
```cpp
auto& circle = entity.AddComponent<CircleRendererComponent>();

circle.Color = { 0.0f, 1.0f, 0.0f, 1.0f };  // ç»¿è‰²
circle.Thickness = 0.8f;  // è¾¹æ¡†åšåº¦ (0-1)
circle.Fade = 0.005f;     // è¾¹ç¼˜æ¸å˜
```

### TextComponent
```cpp
auto& text = entity.AddComponent<TextComponent>();

text.TextString = "Hello World!";
text.Color = { 1.0f, 1.0f, 1.0f, 1.0f };
text.FontAsset = Font::GetDefault();
text.Kerning = 0.0f;
text.LineSpacing = 0.0f;
```

### CameraComponent
```cpp
auto& camera = entity.AddComponent<CameraComponent>();

// è®¾ç½®ä¸ºä¸»ç›¸æœº
camera.Primary = true;

// æ­£äº¤æŠ•å½±
camera.Camera.SetProjectionType(SceneCamera::ProjectionType::Orthographic);
camera.Camera.SetOrthographicSize(10.0f);

// é€è§†æŠ•å½±
camera.Camera.SetProjectionType(SceneCamera::ProjectionType::Perspective);
camera.Camera.SetPerspectiveVerticalFOV(glm::radians(45.0f));

// å›ºå®šçºµæ¨ªæ¯”
camera.FixedAspectRatio = false;
```

---

## è„šæœ¬å¼€å‘

### å®šä¹‰è„šæœ¬ç±»
```cpp
class PlayerController : public ScriptableEntity
{
private:
    float m_Speed = 5.0f;
    
protected:
    // è„šæœ¬åˆ›å»ºæ—¶è°ƒç”¨ï¼ˆåˆå§‹åŒ–ï¼‰
    void OnCreate() override
    {
        HZ_CORE_INFO("PlayerController created!");
    }
    
    // æ¯å¸§æ›´æ–°
    void OnUpdate(Timestep ts) override
    {
        auto& transform = GetComponent<TransformComponent>();
        
        // ç§»åŠ¨é€»è¾‘
        if (Input::IsKeyPressed(Key::W))
            transform.Translation.y += m_Speed * ts;
        if (Input::IsKeyPressed(Key::S))
            transform.Translation.y -= m_Speed * ts;
        if (Input::IsKeyPressed(Key::A))
            transform.Translation.x -= m_Speed * ts;
        if (Input::IsKeyPressed(Key::D))
            transform.Translation.x += m_Speed * ts;
    }
    
    // è„šæœ¬é”€æ¯æ—¶è°ƒç”¨ï¼ˆæ¸…ç†ï¼‰
    void OnDestroy() override
    {
        HZ_CORE_INFO("PlayerController destroyed!");
    }
};
```

### ç»‘å®šè„šæœ¬åˆ°å®ä½“
```cpp
auto& nsc = entity.AddComponent<NativeScriptComponent>();
nsc.Bind<PlayerController>();
```

### è®¿é—®å…¶ä»–ç»„ä»¶
```cpp
void OnUpdate(Timestep ts) override
{
    // è·å–ä»»æ„ç»„ä»¶
    auto& transform = GetComponent<TransformComponent>();
    auto& sprite = GetComponent<SpriteRendererComponent>();
    auto& rb2d = GetComponent<Rigidbody2DComponent>();
    
    // ä¿®æ”¹ç»„ä»¶æ•°æ®
    sprite.Color.r = sin(time);
}
```

---

## ç‰©ç†ç³»ç»Ÿ

### Rigidbody2DComponent
```cpp
auto& rb2d = entity.AddComponent<Rigidbody2DComponent>();

// åˆšä½“ç±»å‹
rb2d.Type = Rigidbody2DComponent::BodyType::Static;    // é™æ€ï¼ˆåœ°é¢ã€å¢™å£ï¼‰
rb2d.Type = Rigidbody2DComponent::BodyType::Dynamic;   // åŠ¨æ€ï¼ˆç©å®¶ã€æ•Œäººï¼‰
rb2d.Type = Rigidbody2DComponent::BodyType::Kinematic; // è¿åŠ¨å­¦ï¼ˆç§»åŠ¨å¹³å°ï¼‰

// å›ºå®šæ—‹è½¬ï¼ˆé˜²æ­¢ç‰©ä½“ç¿»æ»šï¼‰
rb2d.FixedRotation = true;
```

### BoxCollider2DComponent
```cpp
auto& collider = entity.AddComponent<BoxCollider2DComponent>();

// ç¢°æ’ç›’å¤§å°
collider.Size = { 0.5f, 0.5f };

// åç§»é‡ï¼ˆç›¸å¯¹äºå®ä½“ä¸­å¿ƒï¼‰
collider.Offset = { 0.0f, 0.0f };

// ç‰©ç†æè´¨
collider.Density = 1.0f;        // å¯†åº¦ï¼ˆå½±å“è´¨é‡ï¼‰
collider.Friction = 0.5f;       // æ‘©æ“¦åŠ› (0-1)
collider.Restitution = 0.0f;    // å¼¹æ€§ç³»æ•° (0-1ï¼Œ0=ä¸å¼¹ï¼Œ1=å®Œå…¨å¼¹æ€§)
collider.RestitutionThreshold = 0.5f;
```

### CircleCollider2DComponent
```cpp
auto& collider = entity.AddComponent<CircleCollider2DComponent>();

// åŠå¾„
collider.Radius = 0.5f;

// åç§»é‡
collider.Offset = { 0.0f, 0.0f };

// ç‰©ç†æè´¨ï¼ˆåŒç›’ç¢°æ’å™¨ï¼‰
collider.Density = 1.0f;
collider.Friction = 0.5f;
collider.Restitution = 0.0f;
```

### å®Œæ•´ç‰©ç†å®ä½“ç¤ºä¾‹
```cpp
Entity CreatePhysicsEntity(Ref<Scene> scene, const std::string& name)
{
    Entity entity = scene->CreateEntity(name);
    
    // å˜æ¢
    auto& transform = entity.GetComponent<TransformComponent>();
    transform.Translation = { 0.0f, 5.0f, 0.0f };
    
    // æ¸²æŸ“
    auto& sprite = entity.AddComponent<SpriteRendererComponent>();
    sprite.Color = { 1.0f, 0.0f, 0.0f, 1.0f };
    
    // ç‰©ç†
    auto& rb2d = entity.AddComponent<Rigidbody2DComponent>();
    rb2d.Type = Rigidbody2DComponent::BodyType::Dynamic;
    rb2d.FixedRotation = true;
    
    auto& collider = entity.AddComponent<BoxCollider2DComponent>();
    collider.Size = { 0.5f, 0.5f };
    collider.Density = 1.0f;
    collider.Friction = 0.3f;
    
    return entity;
}
```

---

## åœºæ™¯åºåˆ—åŒ–

### ä¿å­˜åœºæ™¯
```cpp
SceneSerializer serializer(scene);
serializer.Serialize("assets/scenes/Level1.hazel");
```

### åŠ è½½åœºæ™¯
```cpp
Ref<Scene> scene = CreateRef<Scene>();
SceneSerializer serializer(scene);

if (serializer.Deserialize("assets/scenes/Level1.hazel"))
{
    HZ_CORE_INFO("Scene loaded successfully!");
}
else
{
    HZ_CORE_ERROR("Failed to load scene!");
}
```

### è¿è¡Œæ—¶åºåˆ—åŒ–ï¼ˆäºŒè¿›åˆ¶ï¼Œæ›´å¿«ï¼‰
```cpp
// ä¿å­˜
serializer.SerializeRuntime("assets/scenes/Level1.bin");

// åŠ è½½
serializer.DeserializeRuntime("assets/scenes/Level1.bin");
```

---

## å®Œæ•´ç¤ºä¾‹

### åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æ¸¸æˆåœºæ™¯

```cpp
void CreateGameScene()
{
    // 1. åˆ›å»ºåœºæ™¯
    Ref<Scene> scene = CreateRef<Scene>();
    
    // 2. åˆ›å»ºç›¸æœº
    Entity camera = scene->CreateEntity("MainCamera");
    auto& cameraComp = camera.AddComponent<CameraComponent>();
    cameraComp.Primary = true;
    cameraComp.Camera.SetProjectionType(SceneCamera::ProjectionType::Orthographic);
    cameraComp.Camera.SetOrthographicSize(10.0f);
    
    // 3. åˆ›å»ºåœ°é¢
    Entity ground = scene->CreateEntity("Ground");
    auto& groundTransform = ground.GetComponent<TransformComponent>();
    groundTransform.Translation = { 0.0f, -5.0f, 0.0f };
    groundTransform.Scale = { 20.0f, 1.0f, 1.0f };
    
    auto& groundSprite = ground.AddComponent<SpriteRendererComponent>();
    groundSprite.Color = { 0.3f, 0.3f, 0.3f, 1.0f };
    
    auto& groundRb2d = ground.AddComponent<Rigidbody2DComponent>();
    groundRb2d.Type = Rigidbody2DComponent::BodyType::Static;
    
    auto& groundCollider = ground.AddComponent<BoxCollider2DComponent>();
    groundCollider.Size = { 10.0f, 0.5f };
    
    // 4. åˆ›å»ºç©å®¶
    Entity player = scene->CreateEntity("Player");
    auto& playerTransform = player.GetComponent<TransformComponent>();
    playerTransform.Translation = { 0.0f, 0.0f, 0.0f };
    
    auto& playerSprite = player.AddComponent<SpriteRendererComponent>();
    playerSprite.Color = { 1.0f, 0.0f, 0.0f, 1.0f };
    
    auto& playerRb2d = player.AddComponent<Rigidbody2DComponent>();
    playerRb2d.Type = Rigidbody2DComponent::BodyType::Dynamic;
    playerRb2d.FixedRotation = true;
    
    auto& playerCollider = player.AddComponent<BoxCollider2DComponent>();
    playerCollider.Size = { 0.5f, 0.5f };
    playerCollider.Density = 1.0f;
    playerCollider.Friction = 0.3f;
    
    auto& playerScript = player.AddComponent<NativeScriptComponent>();
    playerScript.Bind<PlayerController>();
    
    // 5. ä¿å­˜åœºæ™¯
    SceneSerializer serializer(scene);
    serializer.Serialize("assets/scenes/GameScene.hazel");
    
    // 6. å¼€å§‹æ¸¸æˆ
    scene->OnRuntimeStart();
}
```

---

## å¸¸ç”¨å®å’Œå®šä¹‰

```cpp
// å‘½åç©ºé—´
namespace Hazel { /* ... */ }

// æ™ºèƒ½æŒ‡é’ˆ
Ref<Scene>  // å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆï¼ˆç±»ä¼¼ std::shared_ptrï¼‰

// æ–­è¨€
HZ_CORE_ASSERT(condition, "message");

// æ—¥å¿—
HZ_CORE_INFO("Info message");
HZ_CORE_WARN("Warning message");
HZ_CORE_ERROR("Error message");
```

---

## æ€§èƒ½æç¤º

### âœ… é«˜æ•ˆçš„å®ä½“éå†
```cpp
// ä½¿ç”¨ç»„è§†å›¾æ‰¹é‡å¤„ç†
auto view = scene->GetAllEntitiesWith<TransformComponent, SpriteRendererComponent>();
for (auto entity : view)
{
    auto [transform, sprite] = view.get<TransformComponent, SpriteRendererComponent>(entity);
    // å¤„ç†...
}
```

### âŒ ä½æ•ˆçš„æ–¹å¼
```cpp
// ä¸è¦æ¯å¸§æŒ‰åç§°æŸ¥æ‰¾å®ä½“
for (int i = 0; i < 1000; i++)
{
    Entity entity = scene->FindEntityByName("Entity" + std::to_string(i));  // æ…¢ï¼
}
```

### ğŸ’¡ ä¼˜åŒ–å»ºè®®
```cpp
// ç¼“å­˜å®ä½“å¼•ç”¨
class GameLayer
{
private:
    Entity m_Player;
    std::vector<Entity> m_Enemies;
    
public:
    void OnAttach()
    {
        // åªæŸ¥æ‰¾ä¸€æ¬¡
        m_Player = m_Scene->FindEntityByName("Player");
        
        auto view = m_Scene->GetAllEntitiesWith<EnemyComponent>();
        for (auto e : view)
            m_Enemies.push_back({ e, m_Scene.get() });
    }
};
```

---

## è°ƒè¯•æŠ€å·§

### æ‰“å°å®ä½“ä¿¡æ¯
```cpp
void DebugEntity(Entity entity)
{
    HZ_CORE_INFO("=== Entity Debug Info ===");
    HZ_CORE_INFO("Name: {0}", entity.GetName());
    HZ_CORE_INFO("UUID: {0}", entity.GetUUID());
    
    if (entity.HasComponent<TransformComponent>())
    {
        auto& t = entity.GetComponent<TransformComponent>();
        HZ_CORE_INFO("Position: ({0}, {1}, {2})", t.Translation.x, t.Translation.y, t.Translation.z);
        HZ_CORE_INFO("Rotation: ({0}, {1}, {2})", t.Rotation.x, t.Rotation.y, t.Rotation.z);
        HZ_CORE_INFO("Scale: ({0}, {1}, {2})", t.Scale.x, t.Scale.y, t.Scale.z);
    }
}
```

### åœºæ™¯ç»Ÿè®¡
```cpp
void PrintSceneStats(Ref<Scene> scene)
{
    int totalEntities = 0;
    auto view = scene->GetAllEntitiesWith<IDComponent>();
    for (auto e : view) totalEntities++;
    
    HZ_CORE_INFO("Total Entities: {0}", totalEntities);
}
```

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæ·»åŠ ç»„ä»¶æ—¶æ–­è¨€å¤±è´¥ï¼Ÿ
**A**: å®ä½“å·²ç»æœ‰è¯¥ç»„ä»¶ã€‚ä½¿ç”¨ `AddOrReplaceComponent` æˆ–å…ˆæ£€æŸ¥ `HasComponent`ã€‚

### Q: å¦‚ä½•è®©å®ä½“ä¸å—é‡åŠ›å½±å“ï¼Ÿ
**A**: ä½¿ç”¨ `Static` æˆ– `Kinematic` åˆšä½“ç±»å‹ï¼Œæˆ–ä¸æ·»åŠ åˆšä½“ç»„ä»¶ã€‚

### Q: åœºæ™¯æ–‡ä»¶æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: YAML æ ¼å¼ (.hazel æ–‡ä»¶)ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ã€‚

### Q: å¦‚ä½•å®ç°å¤šåœºæ™¯ç®¡ç†ï¼Ÿ
**A**: å‚è€ƒ [Sceneæ¨¡å—è¯¦è§£.md](./Sceneæ¨¡å—è¯¦è§£.md) çš„"åœºæ™¯ç®¡ç†ç­–ç•¥"ç« èŠ‚ã€‚

---

ğŸ“– **éœ€è¦æ›´å¤šä¿¡æ¯ï¼Ÿ** è¯·æŸ¥é˜…å®Œæ•´çš„ [Sceneæ¨¡å—è¯¦è§£.md](./Sceneæ¨¡å—è¯¦è§£.md) æ–‡æ¡£ï¼
